#!/usr/bin/env bash
# Ralph - BMAD Phase 5 Autonomous Execution CLI
# Main entry point with command routing

set -euo pipefail

# Script directory
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly LIB_DIR="$(cd "$SCRIPT_DIR/../lib" && pwd)"
readonly TEMPLATES_DIR="$(cd "$SCRIPT_DIR/../templates" && pwd)"

# Export for sourced scripts
export LIB_DIR
export TEMPLATES_DIR

# Version
readonly VERSION="1.0.0"

# Source core utilities
source "$LIB_DIR/core/output.sh"
source "$LIB_DIR/core/dependencies.sh"

# Command routing function
route_command() {
  local cmd="${1:-}"
  shift || true

  case "$cmd" in
    init)
      source "$LIB_DIR/commands/init.sh"
      cmd_init "$@"
      ;;
    create)
      source "$LIB_DIR/commands/create.sh"
      cmd_create "$@"
      ;;
    list)
      source "$LIB_DIR/commands/list.sh"
      cmd_list "$@"
      ;;
    run)
      source "$LIB_DIR/commands/run.sh"
      cmd_run "$@"
      ;;
    status)
      source "$LIB_DIR/commands/status.sh"
      cmd_status "$@"
      ;;
    archive)
      source "$LIB_DIR/commands/archive.sh"
      cmd_archive "$@"
      ;;
    unarchive)
      source "$LIB_DIR/commands/unarchive.sh"
      cmd_unarchive "$@"
      ;;
    delete)
      source "$LIB_DIR/commands/delete.sh"
      cmd_delete "$@"
      ;;
    show)
      source "$LIB_DIR/commands/show.sh"
      cmd_show "$@"
      ;;
    edit)
      source "$LIB_DIR/commands/edit.sh"
      cmd_edit "$@"
      ;;
    clone)
      source "$LIB_DIR/commands/clone.sh"
      cmd_clone "$@"
      ;;
    config)
      source "$LIB_DIR/commands/config.sh"
      cmd_config "$@"
      ;;
    feedback-report)
      source "$LIB_DIR/commands/feedback_report.sh"
      cmd_feedback_report "$@"
      ;;
    help|--help|-h)
      show_help
      ;;
    --version|-v)
      echo "ralph version $VERSION"
      ;;
    "")
      error "No command specified"
      show_help
      exit 1
      ;;
    *)
      error "Unknown command: $cmd"
      echo ""
      echo "Run 'ralph help' to see available commands"
      exit 1
      ;;
  esac
}

# Help function
show_help() {
  cat <<EOF
Ralph - BMAD Phase 5 Autonomous Execution CLI

Automates story implementation after BMAD sprint planning. Reads BMAD
documentation, configures autonomous loops, and executes Claude Code CLI
iterations until all stories pass quality gates.

USAGE:
  ralph <command> [options]

COMMANDS:

  Project Initialization:
    init [--force] [--install-agent]
        Initialize ralph in a BMAD project by creating ralph/ directory
        structure and config.yaml. Detects BMAD project automatically.

        Options:
          --force           Reinitialize even if already initialized
          --install-agent   Install ralph agent files into project BMAD config
                            (copies agent definition and registers workflow)

  Configuration:
    config <subcommand>
        Manage ralph configuration settings.

        Subcommands:
          show              Display current configuration
          quality-gates     Configure quality gates interactively

  Loop Management:
    create <loop-name> [--epic <id>] [--yes] [--no-branch]
        Create a new loop with configuration for autonomous execution.

        Options:
          --epic <id>     Filter to a specific epic (e.g., EPIC-001)
          --yes           Skip interactive prompts, use defaults
          --no-branch     Don't create git branch

    list [--active] [--archived] [--json]
        List all loops in the project with their status and progress.

        Options:
          --active        Show only active loops
          --archived      Show only archived loops
          --json          Output in JSON format

    show <loop-name> [--json]
        Display detailed information about a specific loop including
        configuration, execution statistics, and story progress.

        Options:
          --json          Output in JSON format

    edit <loop-name>
        Open loop configuration in your default editor (\$EDITOR).
        Validates JSON after editing.

    clone <source> <destination>
        Copy an existing loop to a new loop with reset statistics.
        Useful for reusing configurations.

    delete <loop-name> [--force]
        Remove a loop and its files (does not delete git branch).

        Options:
          --force         Skip confirmation prompt

    archive <loop-name> [--skip-feedback]
        Archive a loop by moving it to ralph/archive/<date>-<name>/.
        Archived loops are read-only for historical record.

        Note: Feedback collection is required before archiving.
        Use --skip-feedback only during development/testing.

        Options:
          --skip-feedback Skip feedback collection (not recommended)

    unarchive <loop-name> [--reset-stats] [--no-branch]
        Restore a loop from archive back to active loops. Preserves
        feedback.json for historical record.

        Options:
          --reset-stats   Reset execution statistics to zero
          --no-branch     Don't create git branch

  Loop Execution:
    run <loop-name> [--dry-run] [--restart]
        Execute a loop to implement stories automatically via Claude.

        Options:
          --dry-run       Simulate execution without running Claude
          --restart       Start from beginning (ignore resume state)

    status <loop-name> [--once] [--refresh <seconds>]
        Monitor loop execution with real-time terminal dashboard.
        Shows current story, progress, iterations, and recent activity.

        Options:
          --once              Show single snapshot, don't refresh
          --refresh <seconds> Set refresh rate (default: 2 seconds)

        Keyboard controls (in watch mode):
          q                   Quit status monitor
          r                   Refresh immediately
          l                   View full log (progress.txt)

  Loop Archival & Analytics:
    archive <loop-name> [--skip-feedback]
        Archive a completed loop after collecting mandatory feedback.
        Moves loop to ralph/archive/ for historical record.

        Options:
          --skip-feedback Skip feedback collection (not recommended)

    unarchive <loop-name> [--reset-stats] [--no-branch]
        Restore a loop from archive back to active status.

        Options:
          --reset-stats   Reset execution statistics to zero
          --no-branch     Don't create git branch

    feedback-report [--json]
        Generate aggregate feedback analytics across all archived loops.
        Shows satisfaction scores, success rates, and common themes.

        Options:
          --json          Output in JSON format

GLOBAL OPTIONS:
  --help, -h        Show this help message
  --version, -v     Show version number

EXAMPLES:
  # Initialize ralph in your BMAD project
  ralph init

  # Initialize with agent integration for BMAD workflows
  ralph init --install-agent

  # Configure quality gates
  ralph config quality-gates

  # View current configuration
  ralph config show

  # Create a loop for a specific epic
  ralph create feature-auth --epic EPIC-002

  # Run the loop with default settings
  ralph run feature-auth

  # Monitor loop progress in real-time
  ralph status feature-auth

  # Archive the loop when done
  ralph archive feature-auth

  # View feedback analytics across all archived loops
  ralph feedback-report

  # List all loops
  ralph list

  # Clone a successful configuration
  ralph clone feature-auth feature-payments

QUALITY GATES:
  Ralph runs configurable quality gates after each story:
    - typecheck: Type checking (if configured)
    - test: Test suite execution (if configured)
    - lint: Code linting
    - build: Project build

  Configure quality gates with 'ralph config quality-gates'.

For more information, visit: https://github.com/snarktank/ralph
EOF
}

# Main execution
main() {
  local cmd="${1:-}"

  # Allow --version and --help to work without dependency check
  if [[ "$cmd" == "--version" ]] || [[ "$cmd" == "-v" ]] || [[ "$cmd" == "help" ]] || [[ "$cmd" == "--help" ]] || [[ "$cmd" == "-h" ]]; then
    route_command "$@"
    return
  fi

  # Validate dependencies for all other commands
  validate_dependencies || exit 1

  route_command "$@"
}

main "$@"
