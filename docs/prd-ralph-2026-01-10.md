# Product Requirements Document: ralph

**Date:** 2026-01-10
**Author:** Jean-Philippe Brule
**Version:** 1.0
**Project Type:** cli-tool
**Project Level:** 3 (Complex, 12-40 stories)
**Status:** Draft

---

## Document Overview

This Product Requirements Document (PRD) defines the functional and non-functional requirements for ralph. It serves as the source of truth for what will be built and provides traceability from requirements through implementation.

**Related Documents:**
- Product Brief: `docs/product-brief-ralph-2026-01-10.md`

---

## Executive Summary

Ralph is a BMAD Phase 4/5 autonomous execution workflow and CLI tool that automates story implementation after sprint planning. It reads sprint-status.yaml, creates custom automation loops, and executes stories autonomously using Claude Code CLI. The CLI enables developers to create, manage, and run different ralph loops within a project, transforming backlogs into ready-to-review PRs without manual coding.

---

## Product Goals

### Business Objectives

1. Reduce manual coding time by 80% for routine story implementation
2. Clear backlogs 3x faster through automated execution
3. Standardize autonomous execution across the team via shared monorepo
4. Collect user feedback to continuously improve ralph

### Success Metrics

- User feedback scores collected via mandatory questionnaire
- Average feedback score > 4/5
- Percentage of loops completing without manual intervention (target: 70%+)
- Team adoption rate (target: 100% of team using ralph)

---

## Functional Requirements

Functional Requirements (FRs) define **what** the system does - specific features and behaviors.

Each requirement includes:
- **ID**: Unique identifier (FR-001, FR-002, etc.)
- **Priority**: Must Have / Should Have / Could Have / Won't Have (MoSCoW)
- **Description**: What the system should do
- **Acceptance Criteria**: How to verify it's complete

---

### CLI Core

#### FR-001: Initialize Ralph in Project

**Priority:** Must Have

**Description:**
`ralph init` command initializes ralph in a BMAD project by creating the necessary directory structure and configuration files.

**Acceptance Criteria:**
- [ ] Creates `ralph/` directory structure
- [ ] Creates `ralph/config.yaml` with default settings
- [ ] Validates BMAD project exists (checks for `docs/sprint-status.yaml` or `bmad/config.yaml`)
- [ ] Fails gracefully with clear error if not a BMAD project
- [ ] Idempotent - safe to run multiple times

**Dependencies:** None

---

#### FR-002: Help Command

**Priority:** Must Have

**Description:**
`ralph help` or `ralph --help` displays usage information for all commands.

**Acceptance Criteria:**
- [ ] Lists all available commands with brief descriptions
- [ ] Shows usage syntax for each command
- [ ] Displays version number
- [ ] Works without any project initialization

**Dependencies:** None

---

#### FR-003: Version Command

**Priority:** Should Have

**Description:**
`ralph --version` displays the current ralph version.

**Acceptance Criteria:**
- [ ] Outputs semantic version number (e.g., 1.0.0)
- [ ] Works without any project initialization

**Dependencies:** None

---

### Loop Creation

#### FR-010: Create Loop Command

**Priority:** Must Have

**Description:**
`ralph create <loop-name>` creates a new loop with specified name, analyzing sprint-status.yaml and generating all required files.

**Acceptance Criteria:**
- [ ] Creates `ralph/loops/<loop-name>/` directory
- [ ] Generates all loop files (loop.sh, prd.json, prompt.md, progress.txt)
- [ ] Validates loop name (alphanumeric + hyphens only)
- [ ] Fails if loop already exists
- [ ] Creates git branch automatically

**Dependencies:** FR-001

---

#### FR-011: Sprint Status Analysis

**Priority:** Must Have

**Description:**
During loop creation, ralph analyzes `docs/sprint-status.yaml` to extract pending stories and epic information.

**Acceptance Criteria:**
- [ ] Reads sprint-status.yaml correctly
- [ ] Identifies all pending stories (status != "completed")
- [ ] Extracts story IDs, titles, points, and acceptance criteria
- [ ] Supports epic filtering (optional scope to single epic)
- [ ] Handles malformed YAML gracefully with clear errors

**Dependencies:** FR-010

---

#### FR-012: Loop File Generation - loop.sh

**Priority:** Must Have

**Description:**
Generates the main orchestration script that runs Claude Code CLI iterations.

**Acceptance Criteria:**
- [ ] Creates executable bash script
- [ ] Includes configurable max iterations
- [ ] Includes stuck detection logic
- [ ] Handles story completion detection
- [ ] Updates sprint-status.yaml on story completion
- [ ] Logs progress to progress.txt

**Dependencies:** FR-010

---

#### FR-013: Loop File Generation - prd.json

**Priority:** Must Have

**Description:**
Generates configuration and execution metadata file for the loop.

**Acceptance Criteria:**
- [ ] Includes project metadata (name, branch, epic filter)
- [ ] Includes configuration (max iterations, stuck threshold, quality gates)
- [ ] Includes execution stats structure (iterations run, stories completed)
- [ ] Includes story notes structure for per-story tracking

**Dependencies:** FR-010

---

#### FR-014: Loop File Generation - prompt.md

**Priority:** Must Have

**Description:**
Generates the context prompt that will be passed to Claude Code CLI on each iteration.

**Acceptance Criteria:**
- [ ] Includes project context (architecture, conventions)
- [ ] Includes current story information dynamically
- [ ] Includes quality gate requirements
- [ ] Includes commit message conventions
- [ ] References relevant documentation paths

**Dependencies:** FR-010

---

#### FR-015: Loop File Generation - progress.txt

**Priority:** Must Have

**Description:**
Generates the iteration log file that tracks loop execution history.

**Acceptance Criteria:**
- [ ] Creates empty file with header template
- [ ] Append-only during execution
- [ ] Includes timestamps for each entry
- [ ] Records story transitions and completion events

**Dependencies:** FR-010

---

#### FR-016: Git Branch Creation

**Priority:** Must Have

**Description:**
Automatically creates and checks out a new git branch when a loop is created.

**Acceptance Criteria:**
- [ ] Creates branch with naming convention `ralph/<loop-name>`
- [ ] Checks out the new branch
- [ ] Fails gracefully if branch already exists (offers to use existing)
- [ ] Works from any git state (clean or dirty - warns if dirty)

**Dependencies:** FR-010

---

#### FR-017: Interactive Loop Configuration

**Priority:** Should Have

**Description:**
During `ralph create`, prompts user for configuration options interactively.

**Acceptance Criteria:**
- [ ] Prompts for epic filter (all epics or specific epic)
- [ ] Prompts for max iterations (with sensible default)
- [ ] Prompts for stuck threshold (with sensible default)
- [ ] Prompts for quality gates to enable
- [ ] Allows skipping with defaults via `--yes` flag

**Dependencies:** FR-010

---

#### FR-018: Quality Gate Configuration

**Priority:** Must Have

**Description:**
Allows configuration of project-specific quality gates (commands to run before marking story complete).

**Acceptance Criteria:**
- [ ] Supports typecheck command configuration
- [ ] Supports test command configuration
- [ ] Supports lint command configuration
- [ ] Supports build command configuration
- [ ] Allows enabling/disabling individual gates
- [ ] Gates are stored in prd.json

**Dependencies:** FR-013

---

#### FR-019: Loop Template Customization

**Priority:** Could Have

**Description:**
Allows users to customize loop templates via project-level overrides.

**Acceptance Criteria:**
- [ ] Checks for `ralph/templates/` directory
- [ ] Uses custom templates if present
- [ ] Falls back to defaults if not present
- [ ] Documents template customization process

**Dependencies:** FR-010

---

### Loop Management

#### FR-020: List Loops Command

**Priority:** Must Have

**Description:**
`ralph list` displays all loops in the project (active and archived).

**Acceptance Criteria:**
- [ ] Lists all loops in `ralph/loops/`
- [ ] Shows loop status (active/archived)
- [ ] Shows creation date
- [ ] Shows story count (completed/total)
- [ ] Supports `--active` and `--archived` filters

**Dependencies:** FR-001

---

#### FR-021: Delete Loop Command

**Priority:** Must Have

**Description:**
`ralph delete <loop-name>` removes a loop and its files.

**Acceptance Criteria:**
- [ ] Prompts for confirmation before deletion
- [ ] Removes entire loop directory
- [ ] Does not delete git branch (warns user to do manually)
- [ ] Supports `--force` flag to skip confirmation
- [ ] Cannot delete archived loops (must unarchive first)

**Dependencies:** FR-020

---

#### FR-022: Show Loop Details Command

**Priority:** Should Have

**Description:**
`ralph show <loop-name>` displays detailed information about a specific loop.

**Acceptance Criteria:**
- [ ] Shows all configuration from prd.json
- [ ] Shows execution statistics
- [ ] Shows story progress breakdown
- [ ] Shows last activity timestamp

**Dependencies:** FR-020

---

#### FR-023: Edit Loop Configuration

**Priority:** Could Have

**Description:**
`ralph edit <loop-name>` opens loop configuration for editing.

**Acceptance Criteria:**
- [ ] Opens prd.json in default editor ($EDITOR)
- [ ] Validates JSON after edit
- [ ] Prevents editing archived loops

**Dependencies:** FR-020

---

#### FR-024: Clone Loop Command

**Priority:** Could Have

**Description:**
`ralph clone <source> <destination>` creates a copy of an existing loop.

**Acceptance Criteria:**
- [ ] Copies all loop files to new directory
- [ ] Resets execution stats in clone
- [ ] Creates new git branch for clone
- [ ] Preserves configuration settings

**Dependencies:** FR-010

---

#### FR-025: Resume Loop State

**Priority:** Should Have

**Description:**
When re-running a loop, resume from the last known state rather than starting over.

**Acceptance Criteria:**
- [ ] Reads last completed story from prd.json
- [ ] Continues from next pending story
- [ ] Preserves attempt counts across runs

**Dependencies:** FR-013

---

### Loop Execution

#### FR-030: Run Loop Command

**Priority:** Must Have

**Description:**
`ralph run <loop-name>` executes the specified loop.

**Acceptance Criteria:**
- [ ] Executes loop.sh in the loop directory
- [ ] Validates loop exists and is not archived
- [ ] Checks out associated git branch first
- [ ] Prevents running multiple loops simultaneously

**Dependencies:** FR-012

---

#### FR-031: Claude CLI Integration

**Priority:** Must Have

**Description:**
Loop execution invokes Claude Code CLI with the configured prompt on each iteration.

**Acceptance Criteria:**
- [ ] Calls `claude` command with correct flags
- [ ] Passes prompt.md content as input
- [ ] Uses `--print` flag for output
- [ ] Uses `--dangerously-skip-permissions` for autonomous execution
- [ ] Handles Claude CLI errors gracefully

**Dependencies:** FR-030

---

#### FR-032: Story Completion Detection

**Priority:** Must Have

**Description:**
Detects when a story has been completed by Claude and updates tracking.

**Acceptance Criteria:**
- [ ] Parses Claude output for completion signals
- [ ] Updates sprint-status.yaml story status to "completed"
- [ ] Updates epic completed_points
- [ ] Records completion in prd.json story notes
- [ ] Logs completion to progress.txt

**Dependencies:** FR-031

---

#### FR-033: Stuck Detection

**Priority:** Must Have

**Description:**
Detects when a story is stuck (multiple failed attempts) and takes action.

**Acceptance Criteria:**
- [ ] Tracks attempt count per story
- [ ] Triggers stuck status when threshold exceeded
- [ ] Pauses loop execution on stuck
- [ ] Logs stuck event with details
- [ ] Configurable stuck threshold (default: 3)

**Dependencies:** FR-031

---

#### FR-034: Quality Gate Execution

**Priority:** Must Have

**Description:**
Runs configured quality gates after each story to validate implementation.

**Acceptance Criteria:**
- [ ] Runs each enabled quality gate command
- [ ] Fails story if any gate fails
- [ ] Logs gate results to progress.txt
- [ ] Continues to next iteration (Claude will fix issues)

**Dependencies:** FR-018

---

#### FR-035: Iteration Logging

**Priority:** Must Have

**Description:**
Logs detailed information about each iteration to progress.txt.

**Acceptance Criteria:**
- [ ] Records iteration number and timestamp
- [ ] Records current story being worked on
- [ ] Records Claude output summary
- [ ] Records quality gate results
- [ ] Records story state transitions

**Dependencies:** FR-015

---

#### FR-036: Graceful Interruption

**Priority:** Should Have

**Description:**
Handles SIGINT/SIGTERM gracefully, preserving state before exit.

**Acceptance Criteria:**
- [ ] Catches interrupt signals
- [ ] Saves current state to prd.json
- [ ] Logs interruption to progress.txt
- [ ] Exits cleanly without corrupting files

**Dependencies:** FR-030

---

#### FR-037: Execution Statistics Tracking

**Priority:** Must Have

**Description:**
Tracks and stores execution statistics throughout the loop run.

**Acceptance Criteria:**
- [ ] Tracks total iterations run
- [ ] Tracks stories completed
- [ ] Tracks start and end timestamps
- [ ] Tracks average iterations per story
- [ ] Stores in prd.json stats object

**Dependencies:** FR-013

---

#### FR-038: Concurrent Execution Prevention

**Priority:** Must Have

**Description:**
Prevents multiple ralph instances from running simultaneously on the same loop.

**Acceptance Criteria:**
- [ ] Creates lock file when loop starts
- [ ] Checks for existing lock before starting
- [ ] Removes lock on clean exit
- [ ] Handles stale locks (with timeout detection)

**Dependencies:** FR-030

---

#### FR-039: Dry Run Mode

**Priority:** Could Have

**Description:**
`ralph run <loop-name> --dry-run` simulates execution without actually running Claude.

**Acceptance Criteria:**
- [ ] Shows what would be executed
- [ ] Validates configuration
- [ ] Lists stories that would be processed
- [ ] Does not modify any files

**Dependencies:** FR-030

---

### Monitoring Dashboard

#### FR-040: Status Command

**Priority:** Must Have

**Description:**
`ralph status <loop-name>` displays real-time monitoring dashboard.

**Acceptance Criteria:**
- [ ] Shows rich terminal UI with colors
- [ ] Updates in real-time while loop is running
- [ ] Works in non-interactive mode (single snapshot) if loop not running

**Dependencies:** FR-030

---

#### FR-041: Progress Visualization

**Priority:** Must Have

**Description:**
Dashboard shows visual progress indicators for story completion.

**Acceptance Criteria:**
- [ ] Progress bar for overall loop completion
- [ ] Progress bar for current epic
- [ ] Story count display (completed/total)
- [ ] Color-coded status indicators

**Dependencies:** FR-040

---

#### FR-042: Current Story Display

**Priority:** Must Have

**Description:**
Dashboard prominently shows the story currently being worked on.

**Acceptance Criteria:**
- [ ] Shows story ID and title
- [ ] Shows story points
- [ ] Shows attempt count for current story
- [ ] Shows time elapsed on current story

**Dependencies:** FR-040

---

#### FR-043: ETA Calculation

**Priority:** Should Have

**Description:**
Dashboard estimates time to completion based on historical pace.

**Acceptance Criteria:**
- [ ] Calculates average time per story
- [ ] Estimates remaining time
- [ ] Updates estimate as loop progresses
- [ ] Shows "Calculating..." until enough data

**Dependencies:** FR-040

---

#### FR-044: Iteration Counter Display

**Priority:** Must Have

**Description:**
Dashboard shows current iteration number and remaining iterations.

**Acceptance Criteria:**
- [ ] Shows current iteration / max iterations
- [ ] Color indicates proximity to limit (green/yellow/red)
- [ ] Shows iterations used per story average

**Dependencies:** FR-040

---

#### FR-045: Stuck Warning Display

**Priority:** Must Have

**Description:**
Dashboard prominently warns when approaching or at stuck threshold.

**Acceptance Criteria:**
- [ ] Shows attempt count vs stuck threshold
- [ ] Warning color when approaching threshold
- [ ] Alert state when stuck threshold reached
- [ ] Shows stuck story details

**Dependencies:** FR-033

---

#### FR-046: Quality Gate Status Display

**Priority:** Should Have

**Description:**
Dashboard shows results of quality gate executions.

**Acceptance Criteria:**
- [ ] Shows pass/fail status for each gate
- [ ] Shows last gate execution time
- [ ] Shows gate failure details on hover/expand

**Dependencies:** FR-034

---

#### FR-047: Log Tail Display

**Priority:** Should Have

**Description:**
Dashboard shows recent entries from progress.txt in a scrollable area.

**Acceptance Criteria:**
- [ ] Shows last N lines of progress log
- [ ] Auto-scrolls as new entries appear
- [ ] Supports scroll-back for history
- [ ] Syntax highlighting for key events

**Dependencies:** FR-040

---

#### FR-048: Dashboard Refresh Rate

**Priority:** Should Have

**Description:**
Dashboard refresh rate is configurable.

**Acceptance Criteria:**
- [ ] Default refresh rate of 2 seconds
- [ ] Configurable via `--refresh <seconds>` flag
- [ ] Supports manual refresh via keypress

**Dependencies:** FR-040

---

#### FR-049: Keyboard Controls

**Priority:** Could Have

**Description:**
Dashboard supports keyboard shortcuts for common actions.

**Acceptance Criteria:**
- [ ] `q` to quit dashboard
- [ ] `r` to manually refresh
- [ ] `p` to pause/resume loop (if supported)
- [ ] `l` to show full log

**Dependencies:** FR-040

---

### Archive & Feedback

#### FR-050: Archive Loop Command

**Priority:** Must Have

**Description:**
`ralph archive <loop-name>` archives a completed loop with mandatory feedback.

**Acceptance Criteria:**
- [ ] Moves loop to `ralph/archive/<date>-<loop-name>/`
- [ ] Requires feedback questionnaire completion
- [ ] Cannot archive without feedback
- [ ] Records archive timestamp

**Dependencies:** FR-020

---

#### FR-051: Mandatory Feedback Questionnaire

**Priority:** Must Have

**Description:**
Before archiving, user must complete a feedback questionnaire.

**Acceptance Criteria:**
- [ ] Overall satisfaction (1-5 scale)
- [ ] Stories requiring manual intervention (count)
- [ ] What worked well? (free text, required)
- [ ] What should be improved? (free text, required)
- [ ] Would you run this configuration again? (yes/no)

**Dependencies:** FR-050

---

#### FR-052: Feedback Storage

**Priority:** Must Have

**Description:**
Stores feedback in the archived loop directory.

**Acceptance Criteria:**
- [ ] Creates `feedback.json` in archived loop
- [ ] Includes all questionnaire responses
- [ ] Includes timestamp
- [ ] Includes loop execution statistics

**Dependencies:** FR-051

---

#### FR-053: Archive Directory Structure

**Priority:** Must Have

**Description:**
Archives follow consistent naming and structure.

**Acceptance Criteria:**
- [ ] Directory name: `<YYYY-MM-DD>-<loop-name>`
- [ ] Contains all original loop files
- [ ] Contains feedback.json
- [ ] Contains final prd.json with stats

**Dependencies:** FR-050

---

#### FR-054: List Archived Loops

**Priority:** Should Have

**Description:**
`ralph list --archived` shows only archived loops with their feedback summaries.

**Acceptance Criteria:**
- [ ] Lists all archived loops
- [ ] Shows archive date
- [ ] Shows feedback score
- [ ] Shows stories completed count

**Dependencies:** FR-020

---

#### FR-055: View Archived Loop Details

**Priority:** Should Have

**Description:**
`ralph show <archived-loop-name>` displays archived loop details including feedback.

**Acceptance Criteria:**
- [ ] Shows all loop configuration
- [ ] Shows execution statistics
- [ ] Shows full feedback responses
- [ ] Indicates loop is read-only (archived)

**Dependencies:** FR-022

---

#### FR-056: Unarchive Loop

**Priority:** Could Have

**Description:**
`ralph unarchive <archived-loop-name>` restores a loop from archive.

**Acceptance Criteria:**
- [ ] Moves loop back to active loops
- [ ] Preserves feedback in loop directory
- [ ] Resets execution stats (optional flag)
- [ ] Creates new git branch if original is gone

**Dependencies:** FR-050

---

#### FR-057: Feedback Analytics

**Priority:** Could Have

**Description:**
`ralph feedback-report` generates aggregate feedback analytics.

**Acceptance Criteria:**
- [ ] Aggregates all feedback from archived loops
- [ ] Shows average satisfaction score
- [ ] Shows common improvement themes
- [ ] Shows success rate trends

**Dependencies:** FR-052

---

#### FR-058: Auto-Archive Suggestion

**Priority:** Could Have

**Description:**
Prompts user to archive when a loop completes all stories successfully.

**Acceptance Criteria:**
- [ ] Detects when all stories are complete
- [ ] Prompts user to archive
- [ ] Allows deferral for later archive

**Dependencies:** FR-050

---

#### FR-059: Skip Feedback Flag

**Priority:** Won't Have (v1)

**Description:**
Allow skipping feedback questionnaire with a flag.

**Rationale:** Feedback is mandatory in v1 to ensure data collection for improvement. May reconsider in future versions.

---

### BMAD Agent Integration

#### FR-060: Agent Definition File

**Priority:** Must Have

**Description:**
Ralph includes a proper BMAD agent definition following BMM agent conventions.

**Acceptance Criteria:**
- [ ] Agent file follows `bmm/agents/` structure
- [ ] Includes agent activation section
- [ ] Includes agent responsibilities
- [ ] Includes agent configuration
- [ ] Compatible with `/ralph` invocation

**Dependencies:** None

---

#### FR-061: Workflow Registration

**Priority:** Must Have

**Description:**
Ralph workflow registers in BMAD workflow system for discoverability.

**Acceptance Criteria:**
- [ ] Workflow appears in `/workflow-status` output
- [ ] Workflow follows Phase 4/5 positioning
- [ ] Workflow has proper input/output documentation

**Dependencies:** FR-060

---

#### FR-062: SKILL.md Integration

**Priority:** Must Have

**Description:**
Ralph maintains comprehensive SKILL.md with full workflow specification.

**Acceptance Criteria:**
- [ ] SKILL.md in `skills/ralph/` directory
- [ ] Includes complete workflow instructions
- [ ] Includes file generation templates
- [ ] Includes loop script template
- [ ] Compatible with Claude Code skill loading

**Dependencies:** FR-060

---

#### FR-063: Auto-Install in Projects

**Priority:** Should Have

**Description:**
`ralph init` can optionally install ralph agent files into a BMAD project.

**Acceptance Criteria:**
- [ ] Copies agent definition to project's BMAD config
- [ ] Registers in project's workflow status
- [ ] Creates project-local ralph configuration
- [ ] Works with both monorepo and standalone setups

**Dependencies:** FR-001

---

#### FR-064: Sprint Status Integration

**Priority:** Must Have

**Description:**
Ralph reads and writes to the same sprint-status.yaml that BMAD sprint planning produces.

**Acceptance Criteria:**
- [ ] Reads story definitions from sprint-status.yaml
- [ ] Updates story status in sprint-status.yaml
- [ ] Updates epic completed_points
- [ ] Does not modify sprint structure
- [ ] Follows BMAD sprint-status schema exactly

**Dependencies:** None

---

#### FR-065: BMAD Config Detection

**Priority:** Must Have

**Description:**
Ralph automatically detects and uses BMAD project configuration.

**Acceptance Criteria:**
- [ ] Reads `bmad/config.yaml` if present
- [ ] Uses configured output folder paths
- [ ] Uses configured sprint status file path
- [ ] Falls back to defaults if BMAD config not found

**Dependencies:** FR-001

---

## Non-Functional Requirements

Non-Functional Requirements (NFRs) define **how** the system performs - quality attributes and constraints.

---

### Performance

#### NFR-001: CLI Response Time

**Priority:** Must Have

**Description:**
CLI commands respond quickly for good user experience.

**Acceptance Criteria:**
- [ ] Non-execution commands complete in < 2 seconds
- [ ] Help and version commands complete in < 0.5 seconds

**Rationale:** Developer tools must feel snappy.

---

#### NFR-002: Dashboard Refresh Performance

**Priority:** Should Have

**Description:**
Monitoring dashboard updates smoothly without flicker.

**Acceptance Criteria:**
- [ ] Dashboard refreshes at configured rate without visible flicker
- [ ] CPU usage stays below 5% when monitoring
- [ ] Works on terminals with at least 80x24 dimensions

**Rationale:** Smooth visual feedback during long-running operations.

---

#### NFR-003: File I/O Efficiency

**Priority:** Should Have

**Description:**
Ralph handles file operations efficiently even with large progress logs.

**Acceptance Criteria:**
- [ ] Appends to progress.txt without reading entire file
- [ ] YAML/JSON parsing handles files up to 1MB without slowdown
- [ ] No memory leaks during long-running loops

**Rationale:** Loops can run for hours generating significant logs.

---

### Reliability

#### NFR-010: State Persistence

**Priority:** Must Have

**Description:**
Loop state is persisted reliably and survives crashes.

**Acceptance Criteria:**
- [ ] State saved after every significant action
- [ ] No data loss on unexpected termination
- [ ] State files remain consistent (no partial writes)

**Rationale:** Loops can run for hours; state loss is unacceptable.

---

#### NFR-011: Atomic File Updates

**Priority:** Must Have

**Description:**
File updates are atomic to prevent corruption.

**Acceptance Criteria:**
- [ ] Uses write-to-temp-then-rename pattern
- [ ] No partial file states on failure
- [ ] sprint-status.yaml never left in invalid state

**Rationale:** YAML/JSON corruption would break BMAD workflows.

---

#### NFR-012: Error Recovery

**Priority:** Must Have

**Description:**
Ralph recovers gracefully from errors and provides actionable messages.

**Acceptance Criteria:**
- [ ] All errors include actionable recovery steps
- [ ] No silent failures
- [ ] Stuck detection allows loop to be resumed after fix

**Rationale:** Users need to understand and fix issues.

---

#### NFR-013: Dependency Validation

**Priority:** Must Have

**Description:**
Ralph validates all dependencies are present before operations.

**Acceptance Criteria:**
- [ ] Checks for jq, yq, git, claude CLI on startup
- [ ] Provides installation instructions for missing deps
- [ ] Validates minimum versions where applicable

**Rationale:** Clear dependency errors save troubleshooting time.

---

#### NFR-014: Idempotent Operations

**Priority:** Should Have

**Description:**
Commands are safe to run multiple times without side effects.

**Acceptance Criteria:**
- [ ] `ralph init` safe to run multiple times
- [ ] Running completed loop resumes from correct state
- [ ] Archive won't re-archive already archived loop

**Rationale:** Users shouldn't fear re-running commands.

---

### Usability

#### NFR-020: Intuitive Command Structure

**Priority:** Must Have

**Description:**
CLI follows common conventions and is intuitive to use.

**Acceptance Criteria:**
- [ ] Commands follow verb-noun pattern
- [ ] Flags use standard conventions (--help, --version)
- [ ] Tab completion friendly (planned for v2)

**Rationale:** Minimizes learning curve for new users.

---

#### NFR-021: Colored Terminal Output

**Priority:** Must Have

**Description:**
Output uses colors for better readability.

**Acceptance Criteria:**
- [ ] Errors in red
- [ ] Warnings in yellow
- [ ] Success in green
- [ ] Headings in bold/cyan
- [ ] Respects NO_COLOR environment variable

**Rationale:** Colors improve scanability of output.

---

#### NFR-022: Clear Error Messages

**Priority:** Must Have

**Description:**
Error messages are clear, specific, and actionable.

**Acceptance Criteria:**
- [ ] States what went wrong
- [ ] States why it went wrong (if known)
- [ ] Suggests how to fix it
- [ ] No cryptic error codes without explanation

**Rationale:** Users should be able to self-diagnose issues.

---

#### NFR-023: Progress Feedback

**Priority:** Must Have

**Description:**
Long-running operations provide progress feedback.

**Acceptance Criteria:**
- [ ] Shows activity indicator for operations > 2 seconds
- [ ] Loop execution shows iteration progress
- [ ] File generation shows step completion

**Rationale:** Users need to know something is happening.

---

#### NFR-024: Confirmation Prompts

**Priority:** Should Have

**Description:**
Destructive operations require confirmation.

**Acceptance Criteria:**
- [ ] Delete commands prompt for confirmation
- [ ] Shows what will be deleted
- [ ] Supports --force flag to skip confirmation
- [ ] Default is "no" for destructive prompts

**Rationale:** Prevents accidental data loss.

---

#### NFR-025: Helpful Defaults

**Priority:** Should Have

**Description:**
Sensible defaults minimize required configuration.

**Acceptance Criteria:**
- [ ] Max iterations defaults to 50
- [ ] Stuck threshold defaults to 3
- [ ] Quality gates default to project-detected settings
- [ ] Defaults can all be overridden

**Rationale:** Reduces friction for getting started.

---

### Compatibility

#### NFR-030: macOS Support

**Priority:** Must Have

**Description:**
Fully functional on macOS (primary development platform).

**Acceptance Criteria:**
- [ ] Works on macOS 12+ (Monterey and later)
- [ ] Works with default macOS bash (zsh-compatible)
- [ ] Works with Homebrew-installed dependencies

**Rationale:** Primary user platform.

---

#### NFR-031: Linux Support

**Priority:** Must Have

**Description:**
Fully functional on common Linux distributions.

**Acceptance Criteria:**
- [ ] Works on Ubuntu 20.04+
- [ ] Works on Debian 11+
- [ ] Works with bash 4.0+
- [ ] No macOS-specific commands

**Rationale:** Secondary user platform, CI environments.

---

#### NFR-032: Terminal Compatibility

**Priority:** Should Have

**Description:**
Works with common terminal emulators.

**Acceptance Criteria:**
- [ ] Works with Terminal.app, iTerm2 on macOS
- [ ] Works with GNOME Terminal, Konsole on Linux
- [ ] Works with VS Code integrated terminal
- [ ] Degrades gracefully in limited terminals

**Rationale:** Users have diverse terminal preferences.

---

#### NFR-033: BMAD Version Compatibility

**Priority:** Must Have

**Description:**
Compatible with current BMAD method version.

**Acceptance Criteria:**
- [ ] Works with BMAD Method v6
- [ ] Reads sprint-status.yaml v1 schema
- [ ] Follows BMAD commit conventions
- [ ] Documents minimum BMAD version required

**Rationale:** Core integration point.

---

#### NFR-034: Claude CLI Compatibility

**Priority:** Must Have

**Description:**
Works with current Claude Code CLI.

**Acceptance Criteria:**
- [ ] Works with Claude Code CLI v1.x
- [ ] Uses stable CLI flags only
- [ ] Abstracts CLI calls for future updates
- [ ] Documents minimum CLI version required

**Rationale:** Core execution dependency.

---

### Maintainability

#### NFR-040: Code Organization

**Priority:** Should Have

**Description:**
Codebase is well-organized and maintainable.

**Acceptance Criteria:**
- [ ] Functions have single responsibility
- [ ] Related functions grouped in modules
- [ ] Consistent naming conventions
- [ ] No files over 500 lines

**Rationale:** Enables team contributions and updates.

---

#### NFR-041: Internal Documentation

**Priority:** Should Have

**Description:**
Code is self-documenting with comments where needed.

**Acceptance Criteria:**
- [ ] All functions have purpose comment
- [ ] Complex logic has explanatory comments
- [ ] Non-obvious decisions documented
- [ ] No orphan TODOs without context

**Rationale:** Future maintainers need context.

---

#### NFR-042: Testing Strategy

**Priority:** Should Have

**Description:**
Key functionality has test coverage.

**Acceptance Criteria:**
- [ ] YAML/JSON parsing has unit tests
- [ ] State management has unit tests
- [ ] Integration test for full loop lifecycle
- [ ] Tests runnable via single command

**Rationale:** Prevents regressions as code evolves.

---

#### NFR-043: Logging for Debugging

**Priority:** Should Have

**Description:**
Debug logging available when troubleshooting.

**Acceptance Criteria:**
- [ ] RALPH_DEBUG=1 enables verbose logging
- [ ] Debug logs include timestamps
- [ ] Debug logs include function names
- [ ] No debug output in normal operation

**Rationale:** Enables troubleshooting without code changes.

---

## Epics

Epics are logical groupings of related functionality that will be broken down into user stories during sprint planning (Phase 4).

Each epic maps to multiple functional requirements and will generate 2-10 stories.

---

### EPIC-001: CLI Foundation

**Description:**
Core CLI infrastructure including initialization, help system, and project detection. This epic establishes the foundation that all other commands build upon.

**Functional Requirements:**
- FR-001: Initialize Ralph in Project
- FR-002: Help Command
- FR-003: Version Command

**Story Count Estimate:** 4-5 stories

**Priority:** Must Have

**Business Value:**
Enables all other ralph functionality. Users cannot use ralph without proper initialization and discoverability.

---

### EPIC-002: Loop Creation

**Description:**
Complete loop creation workflow including sprint analysis, file generation, git branch creation, and configuration. This is the primary creative action in ralph.

**Functional Requirements:**
- FR-010: Create Loop Command
- FR-011: Sprint Status Analysis
- FR-012: Loop File Generation - loop.sh
- FR-013: Loop File Generation - prd.json
- FR-014: Loop File Generation - prompt.md
- FR-015: Loop File Generation - progress.txt
- FR-016: Git Branch Creation
- FR-017: Interactive Loop Configuration
- FR-018: Quality Gate Configuration
- FR-019: Loop Template Customization

**Story Count Estimate:** 8-10 stories

**Priority:** Must Have

**Business Value:**
Transforms sprint planning into executable automation. Without loop creation, ralph has nothing to execute.

---

### EPIC-003: Loop Management

**Description:**
CRUD operations for managing loops after creation. Enables users to list, view, edit, clone, and delete loops.

**Functional Requirements:**
- FR-020: List Loops Command
- FR-021: Delete Loop Command
- FR-022: Show Loop Details Command
- FR-023: Edit Loop Configuration
- FR-024: Clone Loop Command
- FR-025: Resume Loop State

**Story Count Estimate:** 4-5 stories

**Priority:** Must Have

**Business Value:**
Enables management of multiple loops per project. Users need to organize and maintain their automation configurations.

---

### EPIC-004: Loop Execution Engine

**Description:**
Core execution engine that runs loops, integrates with Claude CLI, detects completion/stuck states, and manages the iteration lifecycle.

**Functional Requirements:**
- FR-030: Run Loop Command
- FR-031: Claude CLI Integration
- FR-032: Story Completion Detection
- FR-033: Stuck Detection
- FR-034: Quality Gate Execution
- FR-035: Iteration Logging
- FR-036: Graceful Interruption
- FR-037: Execution Statistics Tracking
- FR-038: Concurrent Execution Prevention
- FR-039: Dry Run Mode

**Story Count Estimate:** 10-12 stories

**Priority:** Must Have

**Business Value:**
This is the core value proposition of ralph - autonomous story execution. Without this, ralph is just a file generator.

---

### EPIC-005: Monitoring Dashboard

**Description:**
Real-time terminal UI for monitoring loop execution with progress bars, ETA, status indicators, and log tailing.

**Functional Requirements:**
- FR-040: Status Command
- FR-041: Progress Visualization
- FR-042: Current Story Display
- FR-043: ETA Calculation
- FR-044: Iteration Counter Display
- FR-045: Stuck Warning Display
- FR-046: Quality Gate Status Display
- FR-047: Log Tail Display
- FR-048: Dashboard Refresh Rate
- FR-049: Keyboard Controls

**Story Count Estimate:** 6-8 stories

**Priority:** Should Have

**Business Value:**
Provides visibility into autonomous execution. Without monitoring, users feel disconnected and anxious during long loops.

---

### EPIC-006: Archive & Feedback

**Description:**
Loop archival system with mandatory feedback collection. Enables continuous improvement through user feedback aggregation.

**Functional Requirements:**
- FR-050: Archive Loop Command
- FR-051: Mandatory Feedback Questionnaire
- FR-052: Feedback Storage
- FR-053: Archive Directory Structure
- FR-054: List Archived Loops
- FR-055: View Archived Loop Details
- FR-056: Unarchive Loop
- FR-057: Feedback Analytics
- FR-058: Auto-Archive Suggestion

**Story Count Estimate:** 5-6 stories

**Priority:** Must Have

**Business Value:**
Captures learning from every loop. Mandatory feedback ensures continuous improvement and user engagement measurement.

---

### EPIC-007: BMAD Agent Integration

**Description:**
Full integration with BMAD method as a proper Phase 4/5 workflow agent. Includes agent definition, workflow registration, and project auto-installation.

**Functional Requirements:**
- FR-060: Agent Definition File
- FR-061: Workflow Registration
- FR-062: SKILL.md Integration
- FR-063: Auto-Install in Projects
- FR-064: Sprint Status Integration
- FR-065: BMAD Config Detection

**Story Count Estimate:** 5-6 stories

**Priority:** Must Have

**Business Value:**
Ensures ralph is a first-class BMAD citizen. Users can invoke ralph naturally within their BMAD workflow without friction.

---

## User Stories (High-Level)

Detailed user stories will be created during sprint planning (Phase 4).

### Representative Stories by Epic:

**EPIC-001 (CLI Foundation):**
- As a developer, I want to run `ralph init` so that I can set up ralph in my BMAD project.
- As a developer, I want to run `ralph help` so that I can learn available commands.

**EPIC-002 (Loop Creation):**
- As a developer, I want to run `ralph create my-feature` so that I get all files needed for autonomous execution.
- As a developer, I want ralph to analyze my sprint-status.yaml so that loops target the right stories.

**EPIC-003 (Loop Management):**
- As a developer, I want to run `ralph list` so that I can see all my loops and their status.
- As a developer, I want to delete a loop so that I can clean up failed experiments.

**EPIC-004 (Loop Execution):**
- As a developer, I want to run `ralph run my-feature` so that stories are implemented automatically.
- As a developer, I want stuck detection so that I'm notified when human intervention is needed.

**EPIC-005 (Monitoring Dashboard):**
- As a developer, I want to see real-time progress so that I know how long until completion.
- As a developer, I want a rich terminal dashboard so that I have all status info at a glance.

**EPIC-006 (Archive & Feedback):**
- As a developer, I want to archive completed loops so that I maintain a clean workspace.
- As a developer, I want to provide feedback so that ralph improves over time.

**EPIC-007 (BMAD Integration):**
- As a BMAD user, I want to invoke `/ralph` so that I can start autonomous execution naturally.
- As a developer, I want ralph to respect my BMAD config so that paths and conventions are consistent.

---

## User Personas

### Primary Persona: Solo BMAD Developer

**Name:** Alex
**Role:** Full-stack developer
**Experience:** 5+ years coding, 1+ year with Claude Code CLI

**Characteristics:**
- Works independently on projects
- Uses BMAD method for all project planning
- Lives in the terminal (CLI-first)
- Values efficiency and automation
- Comfortable with autonomous AI execution
- Prefers reviewing PRs over writing code

**Goals:**
- Clear backlog faster
- Reduce repetitive coding tasks
- Maintain quality while automating
- Learn from each automation run

**Pain Points:**
- Manual coding after sprint planning is tedious
- Context switching between planning and implementing
- Losing momentum on large backlogs
- No visibility into AI progress during long runs

---

## User Flows

### Flow 1: Create and Run Loop (Happy Path)

1. Developer completes BMAD sprint planning (`/sprint-planning`)
2. Developer runs `ralph init` (first time only)
3. Developer runs `ralph create feature-auth`
4. Ralph analyzes sprint-status.yaml, shows stories to include
5. Ralph generates loop files, creates git branch
6. Developer runs `ralph run feature-auth`
7. Developer monitors with `ralph status feature-auth`
8. Loop completes all stories
9. Developer reviews commits, runs final tests
10. Developer runs `ralph archive feature-auth`
11. Developer completes feedback questionnaire
12. Loop is archived with feedback

### Flow 2: Handle Stuck Story

1. Loop is running, story reaches stuck threshold
2. Dashboard shows stuck warning
3. Loop pauses execution
4. Developer reviews progress.txt for details
5. Developer manually fixes issue
6. Developer runs `ralph run feature-auth` (resume)
7. Loop continues from fixed state

### Flow 3: Manage Multiple Loops

1. Developer runs `ralph list` to see all loops
2. Developer runs `ralph show loop-a` for details
3. Developer decides to delete abandoned loop
4. Developer runs `ralph delete loop-b --force`
5. Developer archives completed loop with feedback
6. Developer creates new loop for next epic

---

## Dependencies

### Internal Dependencies

- **BMAD sprint-status.yaml:** Must exist with stories defined. Ralph reads story definitions, updates completion status.
- **Git repository:** Project must be a git repo. Ralph creates branches, relies on git state.
- **BMAD config (optional):** If `bmad/config.yaml` exists, ralph uses its paths.

### External Dependencies

- **jq:** JSON processing (version 1.6+)
- **yq:** YAML processing (version 4.x, Mike Farah's version)
- **git:** Version control (version 2.x+)
- **claude:** Claude Code CLI (version 1.x)
- **bash:** Shell (version 4.0+, or zsh)

---

## Assumptions

1. Users have Claude Code CLI installed and authenticated with valid API access
2. Users have BMAD-initialized project with completed sprint planning
3. Users have jq/yq installed (or willing to install)
4. Git is configured with appropriate permissions for the repository
5. One loop runs at a time per project (no parallel execution v1)
6. Users are comfortable with autonomous AI execution
7. Users will provide honest feedback when archiving
8. Internet connectivity available for Claude API calls

---

## Out of Scope

### Explicitly Out of Scope for v1:

1. **GUI/Web Interface:** CLI-only in v1
2. **Multi-machine Distributed Execution:** Single machine only
3. **CI/CD Pipeline Integration:** No automated triggering
4. **Auto PR Creation:** Commits only, user creates PR
5. **Windows Support:** macOS/Linux only
6. **Parallel Loop Execution:** One loop at a time
7. **Skip Feedback Option:** Feedback is mandatory
8. **Custom AI Model Support:** Claude only

### Future Considerations (v2+):

- Web dashboard for team visibility
- CI/CD integration for automated loop triggering
- Auto PR creation with review assignments
- Parallel loop execution
- Integration with other AI models beyond Claude
- Windows support via WSL

---

## Open Questions

None currently - all major decisions resolved during requirements gathering.

---

## Approval & Sign-off

### Stakeholders

| Role | Name | Influence |
|------|------|-----------|
| Project Lead | Jean-Philippe Brule | High - Defines requirements, approves design |
| Team Developers | Team | High - Primary users, contributors |

### Approval Status

- [ ] Product Owner
- [ ] Engineering Lead
- [ ] Design Lead
- [ ] QA Lead

---

## Revision History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-10 | Jean-Philippe Brule | Initial PRD |

---

## Next Steps

### Phase 3: Architecture

Run `/architecture` to create system architecture based on these requirements.

The architecture will address:
- All functional requirements (FRs)
- All non-functional requirements (NFRs)
- Technical stack decisions
- Data models and APIs
- System components

### Phase 4: Sprint Planning

After architecture is complete, run `/sprint-planning` to:
- Break epics into detailed user stories
- Estimate story complexity
- Plan sprint iterations
- Begin implementation

---

**This document was created using BMAD Method v6 - Phase 2 (Planning)**

*To continue: Run `/workflow-status` to see your progress and next recommended workflow.*

---

## Appendix A: Requirements Traceability Matrix

| Epic ID | Epic Name | Functional Requirements | Story Count (Est.) |
|---------|-----------|-------------------------|-------------------|
| EPIC-001 | CLI Foundation | FR-001, FR-002, FR-003 | 4-5 |
| EPIC-002 | Loop Creation | FR-010 - FR-019 | 8-10 |
| EPIC-003 | Loop Management | FR-020 - FR-025 | 4-5 |
| EPIC-004 | Loop Execution Engine | FR-030 - FR-039 | 10-12 |
| EPIC-005 | Monitoring Dashboard | FR-040 - FR-049 | 6-8 |
| EPIC-006 | Archive & Feedback | FR-050 - FR-058 | 5-6 |
| EPIC-007 | BMAD Agent Integration | FR-060 - FR-065 | 5-6 |

**Total Estimated Stories:** 42-52 stories

---

## Appendix B: Prioritization Details

### Functional Requirements Summary

| Priority | Count | Percentage |
|----------|-------|------------|
| Must Have | 35 | 83% |
| Should Have | 9 | 21% |
| Could Have | 6 | 14% |
| Won't Have (v1) | 1 | 2% |

### Non-Functional Requirements Summary

| Priority | Count | Percentage |
|----------|-------|------------|
| Must Have | 14 | 67% |
| Should Have | 7 | 33% |

### Epic Priority Distribution

| Priority | Epics |
|----------|-------|
| Must Have | EPIC-001, EPIC-002, EPIC-003, EPIC-004, EPIC-006, EPIC-007 |
| Should Have | EPIC-005 |

**MVP Scope:** EPIC-001 through EPIC-004 plus EPIC-006 and EPIC-007 (Must Haves)
**Full Scope:** All epics including EPIC-005 (Monitoring Dashboard)
